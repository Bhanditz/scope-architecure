
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Unified Message Structure &mdash; Scope Interface 1 documentation</title>
    <link rel="stylesheet" href="static/default.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" media="print" href="static/print.css" type="text/css" />
    <script src="static/script.js"></script>
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '#',
        VERSION:     '1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="top" title="Scope Interface 1 documentation" href="index.html" />
    <link rel="next" title="Scope DOM API" href="scope-dom-interface.html" />
    <link rel="prev" title="Scope transport protocol v1" href="scope-transport-protocol.html" /> 
  </head>
  <body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="unified-message-structure">
<h1>Unified Message Structure<a class="headerlink" href="#unified-message-structure" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Jan Borsodi (jborsodi [at] opera.com)</td>
</tr>
<tr class="field-even field"><th class="field-name">Version:</th><td class="field-body">0.2</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">23th June 2009</td>
</tr>
</tbody>
</table>
<p>Unified Message Structure, or UMS for short, is a system for defining message
structures in a generic format which can be exported to and imported from
multiple formats.</p>
<p>The main requirement for the system was to be able to work with XML, JSON and
Protocol Buffers. This is possible by defining a sub-set of all supported
formats.</p>
<p>In addition the system is also meant to assist with code-generation of parsers
and serializers for various languages, reducing the need for manually
crafted code.</p>
<p>The main component is the messages. They define a set of fields which make
up the message. Each field defines a specific type (integer or string)
and information on whether it is required, optional or repeated, in
addition to meta-information like name and a number.
The structure of the message is defined by the name and tag of each field
and the order of the fields.
Name is important for XML, tag is important for Protocol Buffers, and order is important for JSON.
The tag is a number which is unique to that field within each message. Tags
are defined in the range of 1 to (2^31)-1.
The name is a non-empty string written in camel-case.</p>
<p>A tool written in Python is available for dealing with UMS data:
<a class="reference external" href="http://bitbucket.org/scope/hob/">http://bitbucket.org/scope/hob/</a></p>
<div class="section" id="types">
<h2>Types<a class="headerlink" href="#types" title="Permalink to this headline">¶</a></h2>
<p>The types in the system are based upon the types in Protocol Buffers which
consist of a set of integer types, boolean, string and binary.
Nested messages are also possible with a special type called Message.</p>
<p>More details on types can be read in the <a class="reference external" href="http://code.google.com/apis/protocolbuffers/docs/proto.html">Protocol Buffer documentation</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently floating-point numbers are not supported due to the
different nature of floating numbers between different processors.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">64 bit types are not yet supported due to incomplete support for
them in the Opera core.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Enums are not yet supported, should be easy as they are basically sent
as numbers but require some extra handling in the generated code.</p>
</div>
</div>
<div class="section" id="quantifier">
<h2>Quantifier<a class="headerlink" href="#quantifier" title="Permalink to this headline">¶</a></h2>
<p>The quantifier defines whether the field is required or not. If the field
is not required it can be defined as either optional or as being repeated.
A repeated field with zero elements and an optional field which is missing
are considered the same.</p>
</div>
<div class="section" id="style-guide">
<h2>Style guide<a class="headerlink" href="#style-guide" title="Permalink to this headline">¶</a></h2>
<p>The style guide for services and all related elements are explained in
detail in in <tt class="xref doc docutils literal"><span class="pre">style-guide-stp1</span></tt>.</p>
</div>
<div class="section" id="syntax">
<h2>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h2>
<p>The syntax for defining messages is based upon the Protocol Buffers syntax:
<a class="reference external" href="http://code.google.com/apis/protocolbuffers/docs/proto.html">http://code.google.com/apis/protocolbuffers/docs/proto.html</a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently there is no parser for this, and everything is written in pure
Python. A parser will be added once STP/1 and UMS stabilizes.</p>
</div>
</div>
<div class="section" id="supported-formats">
<h2>Supported formats<a class="headerlink" href="#supported-formats" title="Permalink to this headline">¶</a></h2>
<p>UMS is designed to work with XML, JSON and Protocol Buffers. XML and JSON
are text-based formats while Protocol Buffers is an efficient binary format.</p>
<div class="section" id="xml">
<h3>XML<a class="headerlink" href="#xml" title="Permalink to this headline">¶</a></h3>
<p>XML is the least efficient format to use among the supported ones, and is
mainly kept as a way for getting output that is easy-to-read, for instance
for debugging or inspection.</p>
<div class="section" id="id1">
<h4>Types<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">All integer types are encoded/decoded as textual numbers. Size and signs are
checked for when decoding numbers. For instance:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="mi">0</span>
<span class="mi">1</span>
<span class="o">-</span><span class="mi">1</span>
<span class="mi">65536</span>
</pre></div>
</div>
</li>
<li><p class="first"><em>double</em> and <em>float</em> are encoded similar to integers but allows for
fractions. For instance:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="mi">0</span>
<span class="mf">3.14</span>
<span class="o">-</span><span class="mf">200.6</span>
</pre></div>
</div>
</li>
<li><p class="first"><em>bool</em> is encoded/decoded as a textual number with <strong>0</strong> being <strong>false</strong> and <strong>1</strong> being
<strong>true</strong>, other values are not allowed.</p>
</li>
<li><p class="first"><em>string</em> is encoded as UTF-8 XML text with XML entities for certain
characters. For instance:</p>
<div class="highlight-html"><div class="highlight"><pre>Foo
<span class="ni">&amp;lt;</span>element<span class="ni">&amp;gt;</span>
</pre></div>
</div>
</li>
<li><p class="first"><em>bytes</em> is encoded as UTF-8 XML text containing the base-64 representation
of the binary data.</p>
</li>
</ul>
</div>
<div class="section" id="structure">
<h4>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h4>
<p>The name of the message is used in the root element of the <a class="reference internal" href="#xml">XML</a> structure.
Each field in the message is placed as a sub-element with the same name as the
field. If the field is optional and missing no element is made. It is the same with
repeated fields which are empty.</p>
<p>A message representing a <em>user</em>:</p>
<div class="highlight-python"><pre>message User {
  required int32  id = 1;
  required bool   isActive = 2;
  required string firstName = 3;
  required string lastName = 4;
  required float  height = 5;
  optional uint32 age = 6;
}</pre>
</div>
<p>would be encoded like this:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;User&gt;</span>
  <span class="nt">&lt;id&gt;</span>42<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;isActive&gt;</span>1<span class="nt">&lt;/isActive&gt;</span>
  <span class="nt">&lt;firstName&gt;</span>John<span class="nt">&lt;/firstName&gt;</span>
  <span class="nt">&lt;lastName&gt;</span>Doe<span class="nt">&lt;/lastName&gt;</span>
  <span class="nt">&lt;height&gt;</span>1.80<span class="nt">&lt;/height&gt;</span>
<span class="nt">&lt;/User&gt;</span>
</pre></div>
</div>
<p>For repeated fields the element also contains a sub-element for each item
in the repeated field, the name of the sub-element is taken from the field
name by removing the suffix <em>List</em>. This means that a field named <em>windowList</em>
will have sub-elements named <em>window</em>.</p>
<p>For instance representing a height map like this:</p>
<div class="highlight-python"><pre>message HeightMap {
  required uint32 width = 1;
  required uint32 height = 2;
  repeated int32  valueList = 3;
}</pre>
</div>
<p>would result in this:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;HeightMap&gt;</span>
  <span class="nt">&lt;width&gt;</span>2<span class="nt">&lt;/width&gt;</span>
  <span class="nt">&lt;height&gt;</span>2<span class="nt">&lt;/height&gt;</span>
  <span class="nt">&lt;valueList&gt;</span>
   <span class="nt">&lt;value&gt;</span>1<span class="nt">&lt;/value&gt;</span>
   <span class="nt">&lt;value&gt;</span>10<span class="nt">&lt;/value&gt;</span>
   <span class="nt">&lt;value&gt;</span>7<span class="nt">&lt;/value&gt;</span>
   <span class="nt">&lt;value&gt;</span>3<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;/valueList&gt;</span>
<span class="nt">&lt;/HeightMap&gt;</span>
</pre></div>
</div>
<p>The same is true for nested messages. Each <em>item</em> will contain the fields
for the sub-message:</p>
<div class="highlight-python"><pre>message PhoneBook {
  message PhoneNumber {
      required string number = 1;
      optional string extension = 2;
  }
  repeated PhoneNumber phoneNumberList = 1;
}</pre>
</div>
<p>would end up as:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;PhoneBook&gt;</span>
  <span class="nt">&lt;phoneNumberList&gt;</span>
    <span class="nt">&lt;phoneNumber&gt;</span>
      <span class="nt">&lt;number&gt;</span>12345678<span class="nt">&lt;/number&gt;</span>
      <span class="nt">&lt;extension&gt;</span>+47<span class="nt">&lt;/extension&gt;</span>
    <span class="nt">&lt;/phoneNumber&gt;</span>
    <span class="nt">&lt;phoneNumber&gt;</span>
      <span class="nt">&lt;number&gt;</span>555-768<span class="nt">&lt;/number&gt;</span>
    <span class="nt">&lt;/phoneNumber&gt;</span>
  <span class="nt">&lt;/phoneNumberList&gt;</span>
<span class="nt">&lt;/PhoneBook&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="json">
<h3>JSON<a class="headerlink" href="#json" title="Permalink to this headline">¶</a></h3>
<p>JSON uses the order of the fields to pack messages into JSON lists. Lists
were chosen to cut down on the amount of information that is needed to send.</p>
<p>All integer types are encoded/decoded as textual numbers. Size and sign are
checked for when decoding numbers.
Boolean type is encoded/decoded as a textual number with 0 being false and
1 being true. Other values are not allowed.
Strings are encoded as UTF-8 JSON strings.
Binary data is encoded as JSON strings containing the base-64 representation
of the binary data.
Messages are encoded as JSON lists with the order of the fields being kept.
Missing elements are sent as the null type. In addition, trailing elements
which are missing are cut off from the list.
Repeated types are encoded as JSON lists.</p>
<p>For more details on JSON see <span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc4627.html"><strong>RFC 4627</strong></a> or visit <a class="reference external" href="http://json.org">http://json.org</a></p>
<p>For instance this structure:</p>
<div class="highlight-python"><pre>message DummyData {
  required int32 id = 1;
  required string name = 2;
  repeated int32 fib = 3;
}</pre>
</div>
<p>Could be encoded like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;foo&quot;</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]]</span>
</pre></div>
</div>
<p>Using more optional fields:</p>
<div class="highlight-python"><pre>message DummyData {
  required int32 id = 1;
  optional string name = 2;
  message SubData {
    required uint32 field1 = 1;
    optional uint32 field2 = 2;
    optional uint32 field3 = 3;
  }
  required SubData msg = 4;
}</pre>
</div>
<p>Could be encoded like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="kc">null</span><span class="p">,[</span><span class="mi">4</span><span class="p">]]</span>
</pre></div>
</div>
<p>While this would be just as valid:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="kc">null</span><span class="p">,[</span><span class="mi">4</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="section" id="protocol-buffers">
<h3>Protocol Buffers<a class="headerlink" href="#protocol-buffers" title="Permalink to this headline">¶</a></h3>
<p>PB is the most efficient way to transport data for languages that excel
at encoding/decoding binary data (e.g. C/C++). Other languages like JavaScript
and Python might be better off with using JSON.</p>
<p>PB is explained in detail at the main site:
<a class="reference external" href="http://code.google.com/apis/protocolbuffers/docs/overview.html">http://code.google.com/apis/protocolbuffers/docs/overview.html</a></p>
</div>
</div>
<div class="section" id="code-generation">
<h2>Code generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h2>
<p>The system supports code generation of the message structures and encoders/
decoders.</p>
<div class="section" id="c">
<h3>C++<a class="headerlink" href="#c" title="Permalink to this headline">¶</a></h3>
<p>The C++ generator translates the message structures into C++ classes. This
allows C++ code to interact with messages using native structures. Encoding
and decoding is handled as a separate layer and is generated.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We do not use the protoc compiler from Protocol Buffers since the
generated code is not compatible with the limited C++ usage in
the Opera core.</p>
</div>
</div>
<div class="section" id="javascript">
<h3>Javascript<a class="headerlink" href="#javascript" title="Permalink to this headline">¶</a></h3>
<p>Code generation for JavaScript is designed around the fact that JavaScript code will
use JSON for formatting messages on the wire. This means that there
is little need for encoding/decoding of data. Extended code generation
is available when RPC (services) are in use.</p>
<p>To aid in debugging incoming JSON data the system can generate code that
outputs JSON data to a human-readable form.</p>
</div>
<div class="section" id="python">
<h3>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="java">
<h3>Java<a class="headerlink" href="#java" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Unified Message Structure</a><ul>
<li><a class="reference internal" href="#types">Types</a></li>
<li><a class="reference internal" href="#quantifier">Quantifier</a></li>
<li><a class="reference internal" href="#style-guide">Style guide</a></li>
<li><a class="reference internal" href="#syntax">Syntax</a></li>
<li><a class="reference internal" href="#supported-formats">Supported formats</a><ul>
<li><a class="reference internal" href="#xml">XML</a><ul>
<li><a class="reference internal" href="#id1">Types</a></li>
<li><a class="reference internal" href="#structure">Structure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#json">JSON</a></li>
<li><a class="reference internal" href="#protocol-buffers">Protocol Buffers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-generation">Code generation</a><ul>
<li><a class="reference internal" href="#c">C++</a></li>
<li><a class="reference internal" href="#javascript">Javascript</a></li>
<li><a class="reference internal" href="#python">Python</a></li>
<li><a class="reference internal" href="#java">Java</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="scope-transport-protocol.html"
                                  title="previous chapter">Scope transport protocol v1</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="scope-dom-interface.html"
                                  title="next chapter">Scope DOM API</a></p>
            <p class="logo"><a href="index.html">
              <img class="logo" src="static/img-press-logo.png" alt="Logo"/>
            </a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>